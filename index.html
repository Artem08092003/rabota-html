<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Простое тестовое задание</title>
        <link rel="stylesheet" href="style.css" type="text/css">
        <link rel="stylesheet" href="style2.css">
    </head>

    <body>
            <h1>
                Сравнение открытых OLAP-систем<br>
                Big Data: ClickHouse, Druid и Pinot
            </h1>

        <div>
            <p>
                Оригинал-<a href="https://medium.com/@leventov/comparison-of-the-open-source-olap-systems-
                for-big-data-clickhouse-druid-and-pinot-8e042a5ed1c7">https://medium.com/@leventov/comparison-of-the-open-source-olap-systems-<br>
                for-big-data-clickhouse-druid-and-pinot-8e042a5ed1c7</a>
            </p>    

            <p>
                <a href="" target="_blank">ClickHouse</a>,
                <a href="" target="_blank">Druid</a>и
                <a href="" target="_blank">Pinot</a>-
                три открытых хранилища данных, которые позволяют<br>
                выполнять аналитические запросы на больших обьемах данных с интерактивными<br>
                заделжками. Эта статья - перевод <a href="" target="_self">подробного сравнения</a>, выполненного Романом<br>
                Левентовым.
            </p>        
        </div>    

        <main>
            <section>
                <h3>
                    Источники информации
                </h3>

           
                    <p>
                        Подробности реализации <b>ClickHouse</b> стали мне известны от <a href="" target="_self">Алексея Зателепина</a>,<br>
                        одного из <strong>ключевых разработчиков проекта</strong>. Доступная на английском<br>
                        документация достаточно скудна - наилучшим источником игформации служат<br>
                        последние четыре секции <a href="" target="_blank">данной страницы документации</a>.
                    </p>
                
                    <p>
                        <b>Я сам участвую в развитии Druid</b>, но у меня нет личной заинтерисованности в этой<br>
                        системе - по правде говоря, скорее всего в ближайшее время я перестану заниматься<br>
                        её разработкой. Поэтому читатели могут рассчитать на отсутствие какой-либо<br>
                        предвзятности.  
                    </p>

                    <table border="1px">
                        <caption>
                            Это таблица 
                        </caption>
                        <thead>
                            <tr>
                                <th colspan="3">
                                    Меню
                                </th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr>
                                <th>
                                    1 
                                </th>
                                <td>
                                    Чай
                                </td>
                                <td>
                                    299р
                                </td>
                            </tr>

                            <tr>
                                <th>
                                    2
                                </th>
                                <td>
                                    Кофе
                                </td>
                                <td>
                                    499р
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    3
                                </th>
                                <td>
                                    Лимонад
                                </td>
                                <td>    
                                    199р
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <p>
                        Всё, что я буду далее писать про <b>Pinot</b>, основывается на странице <a href="" target="_blank">Архитектура в вики<br>
                        </a>, а также на других страницах вики в разделе <q>Проектная документация</q>.<br>
                        Последний раз они обновлялись в июне 2017 года - больше, чем полгода назад.
                    </p>    

                    <p>
                        Рецензентами оригинальной статьи стали Алексей Зателепин и <a href="" target="_blank">Виталий Людвиченко</a><br>
                        (разработчики ClickHouse), <a href="" target="_blank">Жан Мерлино</a> (самый активный разработчик Druid), <a href="" target="_blank">Кишор<br>
                        Гопалакришна</a> (архитектор Pinot) и <a href="" target="_blank">Жан-Француа Им</a> (разработчик Pinot). Мы<br>
                        присоединяемся к благодарности автора и полагаем, что это многократно повышает<br>
                        авторитетность статьи.
                    </p>

                    <p>
                        <strong>Предупреждение:</strong> статья достаточно большая, поэтому вполне возможно вы захотите<br>
                        ограничиться прочтением раздела “Заключение” в конце.
                    </p>
              
            </section>

            <section>
                <h2>
                    Сходства между системами
                </h2>

                <article>
                    <h3>
                        Связанные данные и вычисления
                    </h3>

                    <p>
                        <b>На фундаментальном уровне, ClickHouse, Druid и Pinot похожи,</b> поскольку они<br>
                        хранят данные и выполняют обработку запросов на одних и тех же узлах, уходя от <br>
                        “разъединенной” архитектуры BigQuery. Недавно я уже описывал несколько<br>
                        наследственных проблем со связанной архитектурой в случае Druid <a href="" target="_blank">[1, 2]</a>. Открытого<br>
                        эквивалента для BigQuery на данный момент не существует (за исключением, разве<br>
                        что, <a href="" target="_blank">Drill</a>?) Возможным подходам к построению подобных открытых систем посвящена<br>
                        <a href="" target="_blank">другая статье в моем блоге</a> .
                    </p>
                </article>

                <article>
                    <h3>
                        Отличия от Big Data SQL-систем: индексы и статическое<br>
                        распределение данных
                    </h3>
        
                    <p>
                        Рассматриваемые в этой статье системы <a href="">выполняют запросы быстрее</a>, чем<br>
                        системы Big Data из семейства класса SQL-on-Hadoop: Hive, Impala, Presto и Spark,<br>
                        даже когда последние получают доступ к данным, хранящимся в колоночном формате<br>
                        - к примеру, Parquet или Kudu. Это происходит потому, что в ClickHouse, Druid и Pinot:
					</p>

                        <ul>
                            <li>
                                Имеется <b>свой собственный формат для хранения данных с индексами</b>, и<br>
                                они тесно интегрированы с движками обработки запросов. Системы класса<br>
                                SQL-on-Hadoop обычно можно назвать агностиками относительно форматов<br>
                                данных и поэтому они менее “навязчивы” в бэкендах Big Data.
                            </li>

                            <li>
                                <b>Данные распределены относительно “статично”</b> между узлами, и при<br>
                                распределенном выполнении запроса это можно использовать. Обратная<br>
                                сторона медали при этом в том, что ClickHouse, Druid и Pinot <b>не поддерживают<br>
                                запросы, которые требуют перемещения большого количества данных</b><br>
                                между узлами - к примеру, join между двумя большими таблицами.
                            </li>
                        </ul>
                   
                </article>

                <article>
                    <h3>
                        Отсутствие точечных обновлений и удалений
                    </h3>

                    <p>
                        Находясь на другой стороне спектора баз данных, ClickHouse, Druid и Pinot <b>не<br>
                        поддерживают точечные обновления и удаления</b>, в противоположность<br>
                        колоночным системам вроде Kudu, InfluxDB и Vertica (?). Это даёт ClickHouse, Druid и<br>
                        Pinot возможность производить более эффективное колоночное сжатие и более<br>
                        агрессивные индексы, что означает <b>большую эффективность использования<br>
                        ресурсов</b> и быстрое выполнение запросов.
                    </p>

                    <p>
                        Разработчики ClickHouse в Yandex планируют начать поддерживать <a href="">обновления и<br>
                        удаления в будущем</a>, но я не уверен, будут ли это “настоящие” точечные запросы или<br>
                        обновления/удаления диапазонов данных.
                    </p>
                </article>

                <article>
                    <h3>
                        Поглощение в стиле Big Data 
                    </h3>

                    <p>
                        Все три системы поддерживают потоковое поглощение данных из Kafka. Druid и Pinot<br>
                        поддерживают потоковую передачу данных стриминг в <a href="">Лямбда-стиле</a> и пакетное<br>
                        поглощение одних и тех же данных. ClickHouse поддерживает пакетные вставки<br>
                        напрямую, поэтому ему не требуется отдельная система пакетного поглощения<br>
                        подобная той, что используется в Druid и Pinot. Если вас интересуют подробности, то<br>
                        их вы сможете найти далее.
                    </p>
                </article>

                <article>
                    <h3>
                        Проверено на крупном масштабе
                    </h3>

                    <p>
                        Все три системы проверены на работоспособность в крупных масштабах: в<br>
                        <a href="">Yandex.Metrica работает кластер ClickHouse</a>, состоящий из примерно десятка тысяч<br>
                        ядер CPU. В Metamarkets используется <a href="">кластер Druid аналогичного размера</a>. Один<br>
                        кластер Pinot в LinkedIn включает в себя “<a href="">тысячи машин</a>”. 
                    </p>
                </article>

                <article>
                    <h3>
                        Незрелость
                    </h3>

                    <p>
                        Все рассматриваемые в статье системы являются <b>незрелыми по меркам открытых<br>
                        enterprise-систем Big Data</b>. Однако, скорее всего они незрелы не более, чем<br>
                        среднестатистическая открытая система Big Data - но это совсем другая история. В<br>
                        ClickHouse, Druid и Pinot недостает некоторых очевидных оптимизаций и<br>
                        функциональности, и они кишат багами (насчет ClickHouse и Pinot я не уверен на все<br>
                        100%, но не вижу причин, по которым они в этом плане были бы лучше Druid).
                    </p>

                    <p>
                        Это плавно подводит нас к следующему важному разделу.
                    </p>
                </article>
            </section>

            <section>
                <h2>
                    Про сравнения производительности и выбор системы
                </h2>
                
                <p>
                    Я регулярно вижу в сети, как некоторые проводят сравнения систем больших данных:<br>
                    они берут набор своих данных, каким-либо образом “скармливают” его оцениваемой<br>
                    системе, а затем немедленно пытаются измерить производительность - сколько<br>
                    памяти или дискового пространства было занято, и насколько быстро выполнялись<br>
                    запросы. Причем понимание того, как устроены изнутри испытываемые ими системы, у<br>
                    них отсутствует. Затем, используя лишь подобные специфичные данные о<br>
                    производительности - иногда вместе со списками функциональности, которая им<br>
                    нужна и которая есть в системе на настоящий момент, - они в итоге делают свой<br>
                    выбор или, что еще хуже, выбирают написать свою собственную, “лучшую” систему с<br>
                    нуля.
                </p>

                <p>
                    Такой подход мне кажется неправильным, по крайней мере он неприменим в<br>
                    отношении открытых OLAP-систем для Big Data. Задача создания системы Bid Data<br>
                    OLAP, которая смогла бы работать эффективно в большинстве сценариев<br>
                    использования и содержала бы все необходимые функции настолько велика, что я<br>
                    оцениваю ее реализацию как минимум в <b>100 человеко-лет</b>.
                </p>

                <p>
                    На сегодня, ClickHouse, Druid и Pinot оптимизированы <i>только</i> для конкретных<br>
                    сценариев использования, которые требуются их разработчиком - и содержат по<br>
                    большей части лишь те функции, в которых нуждаются сами разработчики. Я могу<br>
                    гарантировать, что ваш случай обязательно “упрется” в те узкие места, с которыми<br>
                    разработчики рассматриваемых OLAP-систем еще не сталкивались - или же в те<br>
                    места, что их не интересуют.
                </p>

                <p>
                    Не говоря уже о том, что упомянутый выше подход “забросить данные в систему, о<br>
                    которой вы ничего не знаете, и затем измерить её эффективность” весьма вероятно<br>
                    даст искаженный результат из-за серьезных “узких” мест, которые на самом деле<br>
                    могли бы быть исправлены <b>простым изменением конфигурации</b>, схемы данных или<br>
                    другим построением запроса.
                </p>

                <article>
                    <h3>
                        CloudFlare: ClickHouse против Druid
                    </h3>

                    <p>
                        Одним таким примером, хорошо иллюстрирующим описанную выше проблему,<br>
                        является пост Марека Вавруша о <a href="">выборе между ClickHouse и Druid в Cloudflare</a>. Им<br>
                        потребовалось 4 сервера ClickHouse (которые со временем превратились в 9), и по их<br>
                        оценкам, для разворачивания аналогичной установки Druid им бы потребовались<br>
                        “сотни узлов”. Пусть Марек и признает, что <b>сравнение является нечестным</b>,<br>
                        поскольку Druid недостаёт “сортировки по первичному ключу”, он возможно даже не<br>
                        осознает, что достичь примерно того же самого эффекта в Druid возможно просто<br>
                        <a href="">установив правильный порядок измерений в “<i>ingestion spec</i>”</a> и произведя простую<br>
                        подготовку данных: обрезать значение колонки <code>__time</code> в Druid до некоей грубой<br>
                        детализации (к примеру, один час) и опционально добавить другую “длинно-типовую”<br>
                        колонку “precise_time”, если для некоторых запросов требуются более точные<br>
                        временные рамки. Да, это хак, но, как мы только что выяснили, и в Druid можно<br>
                        сортировать данные по какому-либо измерению перед <code>__time</code>, и это достаточно<br>
                        просто реализовать.
                    </p>

                    <p>
                        Впрочем, я не стану спорить с их итоговым решением выбрать ClickHouse, поскольку<br>
                        на масштабе примерно в 10 узлов и для их нужд ClickHouse мне тоже кажется лучшим<br>
                        ыбором, чем Druid. Но сделанное ими заключение о том, что ClickHouse как минимум<br>
                        на порядок эффективнее (по меркам стоимости инфраструктуры), чем Druid - это<br>
                        серьезное заблуждение. На самом деле, из рассматриваемых нами сегодня систем,<br>
                        <b>Druid предлагает наилучшую возможность для реально дешевых установок</b><br>
                        (смотрите раздел “Уровни узлов обработки запросов в Druid ” ниже).
                    </p>
                    
                
                        <blockquote>
                            Когда вы выбираете систему OLAP Big Data, не сравнивайте то, насколько они<br>
                            сейчас хорошо подходят для вашего случая. Сейчас они все субоптимальны.<br>
                            Вместо этого, сравните, насколько быстро ваша компания способна заставить<br>
                            двигаться эти системы в том направлении, которое нужно именно вам.
                        </blockquote>
                   

                    <p class="p">
                        В силу своей фундаментальной архитектурной схожести, ClickHouse, Druid и Pinot<br>
                        имеют примерно один и тот же “предел” эффективности и оптимизации<br>
                        производительности. Здесь нет “волшебной таблетки”, которая позволила бы какой-<br>
                        либо из этих систем быть быстрее, чем остальные. Не позволяйте запутать себя тем<br>
                        фактом, что <i>в своем текущем состоянии</i> системы показывают себя очень по-разному<br>
                        в различных бенчмарках.
                    </p>
                
                    <p>
                        Допустим, Druid не поддерживает “сортировку по первичному ключу” настолько<br>
                        хорошо, насколько это умеет ClickHouse - а ClickHouse в свою очередь не<br>
                        поддерживает “инвертированные индексы” столь же хорошо, как Druid, что дает<br>
                        данным системам преимущества с той или иной нагрузкой. <b>Упущенные оптимизации<br>
                        могут быть реализованы в выбранной системе при помощи не таких уж и<br>
                        больших усилий</b>, если у вас есть намерение и возможность решиться на подобный<br>
                        шаг.
                    </p>

                    <ul>
                        <li>
                            В вашей организации должны быть инженеры, способные прочитать, понять и<br>
                            модифицировать исходный код выбранной системы, к тому же у них должно<br>
                            быть на это время. Заметьте, что ClickHouse написан на C++, а Druid и Pinot —<br>
                            на Java.
                        </li>

                        <li>
                            Или же ваша организация должна подписать контракт с компанией, которая<br>
                            оказывает поддержку выбранной системы. Это будут <a href="">Altinity</a> для ClickHouse,<br>
                            <a href="">Imply</a> и <a href="">Hortonworks</a> для Druid. Для Pinot таких компаний в данный момент нет.
                        </li>
                    </ul>

                    <p>
                        Другие сведения о разработке систем, которые вам стоит принять во внимание:
                    </p>

                    <ul>
                        <li>
                            Авторы ClickHouse, работающие в Yandex, утверждают, что они тратят 50%<br>
                            своего времени на создание функциональности, которая требуется им внутри<br>
                            компании, и другие 50% уходят на функции, который набирают большинство<br>
                            “голосов сообщества”. Однако, чтобы вы получили от этого факта<br>
                            преимущество, требуется, чтобы <b>функции, которые нужны вам, были и<br>
                            наиболее востребованы сообществом</b> ClickHouse.
                        </li>

                        <li>
                            Разработчики Druid из Imply мотивированы работать над широко<br>
                            используемыми функциями, поскольку это позволит им максимально увеличить<br>
                            объем охвата своего бизнеса в будущем.
                        </li>

                        <li>
                            Процесс разработки Druid сильно напоминает <a href="">модель Apache</a>, когда ПО<br>
                            несколько лет разрабатывается несколькими компаниями, у каждой из который<br>
                            достаточно своеобразные и различные приоритеты, и среди них нет ведущей<br>
                            компании. ClickHouse и Pinot пока еще далеки от подобного этапа, поскольку<br>
                            ими занимаются соответственно лишь Yandex и Linkedin. Сторонний вклад в<br>
                            развитие Druid имеет минимальный шанс быть отклоненным в силу того, что он<br>
                            расходится с видением основного разработчика - ведь в <b>Druid нет “основной”<br>
                            компании-разработчика</b>.
                        </li>

                        <li>
                            Druid поддерживает “API разработчика”, который позволяет привносить<br>
                            собственные типы колонок, механизмы агрегации, возможные варианты для<br>
                            «глубокого хранения» и пр., причем все это вы можете держать в кодовой базе,<br>
                            отдельной от самого ядра Druid. Данное API документировано разработчиками<br>
                            Druid, и они следят за его совместимостью с предыдущими версиями. Однако,<br>
                            оно недостаточно “взрослое”, и ломается практически с каждым новым релизом<br>
                            Druid. Насколько мне известно, в ClickHouse и Pinot схожие API не<br>
                            поддерживаются.
                        </li>

                        <li>
                            Согласно Github, <b>над Pinot работает наибольшее число людей</b> - по всей<br>
                            видимости, лишь за прошлый год в Pinot было вложено <a href="">не менее 10 человеко-<br>
                            лет</a>. Для ClickHouse эта цифра составляет примерно 6 человеко-лет, а для<br>
                            Druid - 7 В теории, это должно означать, что Pinot улучшается быстрее всех<br>
                            остальных систем, которые мы рассматриваем.
                        </li>
                    </ul>

                    <p>
                        Архитектуры Druid и Pinot почти что идентичны друг другу, в то время как ClickHouse<br>
                        стоит слегка в стороне. Поэтому сначала мы сравним ClickHouse c “обобщенной”<br>
                        архитектурой Druid/Pinot, а затем обсудим мелкие различия между Druid и Pinot.
                    </p>
                </article>
            </section>

            <section>
                <h2>
                    Различия между ClickHouse и Druid/Pinot
                </h2>

                <article>
                    <h3>
                        Управление данными: Druid и Pinot
                    </h3>

                    <p>
                        В Druid и Pinot, все данные в каждой “таблице” (как бы она не называлась в<br>
                        терминологии этих систем) разбиваются на указанное количество частей. По<br>
                        временой оси, данные обычно разделены с заданым интервалом. Затем эти части<br>
                        данных «запечатываются» индивидуально в самостоятельные автономные сущности,<br>
                        называемые «сегментами». Каждый сегмент включает в себя метаданные таблицы,<br>
                        сжатые столбчатые данные и индексы.
                    </p>

                    <p>
                        Сегменты хранятся в файловой системе хранилища «глубокого хранения» (например,<br>
                        HDFS) и могут быть загружены на узлы обработки запросов, но последние не<br>
                        отвечают за устойчивость сегментов, поэтому узлы обработки запросов могут быть<br>
                        заменены относительно свободно. <b>Сегменты не привязаны жестко к конкретным<br>
                        узлам</b> и могут быть загружены на те или другие узлы. Специальный выделенный<br>
                        сервер (который называется “координатором” в Druid и “контроллером” в Pinot, но я<br>
                        ниже обращаюсь к нему как к “мастеру”) отвечает за присвоение сегментов узлам, и<br>
                        перемещению сегментов между узлами, если потребуется.
                    </p>

                    <p>
                        Это не противоречит тому, что я отмечал выше, все три системы имеют статическое<br>
                        распределение данных между узлами, поскольку загрузки сегментов и их<br>
                        перемещения в Druid - и насколько я понимаю в Pinot - являются дорогими<br>
                        операциями и потому не выполняются для каждой отдельной очереди, а происходят<br>
                        обычно раз в несколько минут/часов/дней.
                    </p>

                    <p>
                        Метаданные сегментов хранятся в ZooKeeper - напрямую в случае Druid, и при<br>
                        помощи фреймворка <a href="">Helix</a> в Pinot. В Druid метаданные также хранятся в базе SQL, об<br>
                        этом будет подробнее в разделе “Различия между Druid и Pinot”.
                    </p>
                </article> 

                <article>
                    <h3>
                        Управление данными: ClickHouse
                    </h3>

                    <p>
                        В ClickHouse нет “сегментов”, содержащих данные, попадающие в конкретные<br>
                        временные диапазоны. В нем нет “глубокого хранения” для данных, узлы в кластере<br>
                        ClickHouse также отвечают и за обработку запросов, и за постоянство/устойчивость<br>
                        данных, хранящихся на них. Так что вам <b>не потребуется HDFS</b> или облачное<br>
                        хранилище данных вроде Amazon S3.
                    </p>

                    <p>
                        В ClickHouse имеются секционированные таблицы, состоящие из указанного набора<br>
                        узлов. Здесь нет “центральной власти” или сервера метаданных. Все узлы, между<br>
                        которыми разделена та или иная таблица, содержат полные, идентичные копии<br>
                        метаданных, включая адреса всех остальных узлов, на которых хранятся секции этой<br>
                        таблицы.
                    </p>

                    <p>
                        Метаданные секционированной таблицы включают “весы” узлов для распределения<br>
                        свежезаписываемых данных - к примеру, 40% данных должны идти на узел A, 30% на<br>
                        узел B и 30% на C. Обычно же распределение должно происходить равномерно,<br>
                        “перекоос”, как в этом примере, требуется только тогда, когда к секционированной<br>
                        таблице добавляется новый узел и нужно побыстрее заполнить его какими-либо<br>
                        данными. <b>Обновления этих “весов” должны выполняться вручную</b><br>
                        администраторами кластера ClickHouse, или же автоматизированной системой,<br>
                        построенной поверх ClickHouse.
                    </p>
                </article>

                <article>
                    <h3>
                        Управление данными: сравнение
                    </h3>

                    <p>
                        Подход к управлению данными в ClickHouse проще, чем в Druid и Pinot: не требуется<br>
                        “глубокого хранилища”, всего один тип узлов, не требуется выделенного сервера для<br>
                        управления данными. Но подход ClickHouse приводит к некоторым трудностям, когда<br>
                        любая таблица данных вырастает настолько большой, что требуется ее разбиение<br>
                        между десятком или более узлов: коэффициент усиления запроса становится<br>
                        настолько же велик, насколько и фактор секционирования - даже для запросов,<br>
                        которые покрывают небольшой интервал данных:
                    </p>
                    
                    <figure>
                        <img src="img.png" width="500" height="300" alt="photo ClickHouse"><br>
                        <figcaption class="ClickHouse"><i>Компромисс распределения данных в ClickHouse</i></figcaption>
                    </figure>
                </article>
            </section>
        </main> 
    </body>
</html>